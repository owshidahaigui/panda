## 职责：

### 用户注册与权限管理模块

#### 验证码

前端发来一个验证码的get请求，通过URL映射到验证码的试图函数（yanzhengma）,先通过随机数模块在（a-z,A-Z,0-9）的字符池，取4位不重复的数，通过这个函数通过导入Python的第三方库PIL的image, ImageDraw, ImageFont,下的方法生成一张图片，图片保存到静态文件，以时间戳加随机数作为一个文件名，并将文件路径和数值通过JSON格式发给到前端

#### ajax异步查询username，email，phone，是否存在

前端会实时监控，用户的username，email，phone，通过ajax，get方式发送信息到后端，后端接收到这些数据之后就会进行数据查询，判断查询结果为空，发送响应的JSON数据到前端

#### 注册主视图

获取前端发来的POST请求，通过POST方法获得username，email，phone，passwd1,passwd2首先判断两次密码是否相同，相同的话，将密码都是hash加密，然后将username，email，phone，passwd就生成一个user对象，将数据存入数据库。并返回完成注册的JSON数据到前端

#### 登录主视图

接收POST请求，从中提取username，passwd，使用username和passwd的hash加密结果值，对数据库查询，使用django的orm，自带的get方法查询结果，使用try进行捕捉异常，如果发生异常意味着没有相关用户，返回前端用户名或者密码错误的JSON信息，账号密码正确的话，将用户name和用户id放到session中并返回登录成功JSON到前端。

#### 登录成功之后把登录时间放到cookie中



#### 登录检测（中间件）

为了对用户是否登录进行权限检测，开发了一个中间件模块，在settings增建一个URL_list的常量，将需要登录才能进入的路由放进去，导入到中间件模块，新建一个中间类（继承django的中间件类），在里面重写了了process_request()方法，通过判断进入要求登录路由时，request对象的session属性中是否包含'userinfo'的键的条件，如果没有条件不符合就返回重定向到登录界面的响应。条件成立返回none，

#### 中间件判断本次会话的登录时间是否为和数据库的login_time是否相同，一个用户同一时间是能在一个客户端有效,唯一

第二个中间件就是取cookie的login_time字段，判断和数据库中该用户字段的login_time时间，如果小于就直接返回x响应对象

#### 统计用户日注册量和用户日活跃人数

定时统计用户表中的create_time是在过去一天时间的用户量，插入到日注册表的新记录，同理日活跃人数，就是用户的updatetime，update为每条请求更新一次



#### 手机验证和邮箱验证

后端在接收到前端的请求之后，首先获取session中用户id，通过数据库查询用户的phone码，在随机生成一组6位数，调用阿里云的第三方接口，通过短信的方式将随机数发给该手机号码，并将随机数通过JSON发送给前端，让前端器检查用户输入是否正确。

邮箱的逻辑也是和这个类似，使用了django的自带的email模块。

#### 修改密码和忘记密码

接收到前端的请求之后，根据前端的JSON信息中，判断是通过短信还是邮件的方式，提取session中user_id，从数据库中提取email或者phone账号，创建随机数并调用响应模块发送短信或者邮件，并将信息发送到前端，前端验证成功后会发送2个新用户密码，判断密码是否一样，是的话，就通过session中userid，修改数据库中用户的密码。

#### 修改头像（文件上传）

#### 用户退出

删除session

### 商家管理模块

#### 查看产品列表

根据前端发送的URL，进入商家管理界面的视图函数，从session中提取user_id,通过user_id判断在店铺表store里查询，如果不存在，就返回错误异常，如果存在通过店铺id，查询商品表，店铺商品类别，通过JSON发送到前端。

#### 删除产品

接收前端的信息，拿到商品id，通过商品id查询数据库，查看产品是否存在，在得到店铺id，从session中拿到userid，查询storei_id,判断非空之后，在判断两次查询到的店铺id是否相同，如果相同就删除数据库记录，并将删除成功的信息返回前端。

#### 上架产品

接收前端发送过来的商品的淘宝链接（用于后台会有程序进行爬虫得到淘宝产品信息），优惠券链接，通过user_id，得到店铺id，产品对象将淘宝链接和优惠券连接，即店铺id存进去。

#### 修改产品。。。。。。。。。。

